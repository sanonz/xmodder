# 实施计划 - RBAC权限体系

## 任务拆分

### 阶段一：基础架构搭建

- [ ] **1. 角色实体和数据库设计**
  - 创建 Role 实体类 (`src/auth/entities/role.entity.ts`)
  - 扩展 User 实体添加角色关联关系
  - 创建数据库迁移文件
  - 添加角色相关的 DTO 类
  - _需求: 需求1, 需求2_

- [ ] **2. 角色服务层实现**
  - 创建 RoleService (`src/auth/services/role.service.ts`)
  - 实现角色的 CRUD 操作
  - 实现用户角色管理方法
  - 实现系统默认角色初始化
  - _需求: 需求1, 需求2_

- [ ] **3. JWT 载荷扩展**
  - 扩展 JwtPayload 接口添加角色信息
  - 修改 AuthService 的 token 生成逻辑
  - 更新 JWT 策略的验证逻辑
  - 确保角色信息正确注入到请求上下文
  - _需求: 需求3_

### 阶段二：权限控制核心实现

- [ ] **4. 装饰器实现**
  - 完善 Public 装饰器 (`src/auth/decorators/public.decorator.ts`)
  - 创建 Roles 装饰器 (`src/auth/decorators/roles.decorator.ts`)
  - 添加装饰器的 TypeScript 类型定义
  - 编写装饰器使用示例和文档
  - _需求: 需求5, 需求6_

- [ ] **5. 角色守卫实现**
  - 创建 RolesGuard (`src/auth/guards/roles.guard.ts`)
  - 实现角色验证的核心逻辑
  - 集成 Reflector 获取元数据
  - 处理公共接口和角色要求的逻辑
  - _需求: 需求4_

- [ ] **6. 全局守卫配置**
  - 在 AppModule 中注册全局守卫
  - 配置守卫执行顺序
  - 确保现有认证流程不被破坏
  - 添加守卫相关的配置文档
  - _需求: 需求4_

### 阶段三：异常处理和审计

- [ ] **7. 权限异常处理**
  - 扩展全局异常过滤器处理权限错误
  - 标准化权限相关的错误响应格式
  - 添加详细的错误信息和错误码
  - 确保响应符合 IResponseBody 规范
  - _需求: 需求7_

- [ ] **8. 审计日志扩展**
  - 扩展 AuditEventType 枚举添加权限事件
  - 在角色变更时记录审计日志
  - 在权限验证失败时记录日志
  - 添加权限操作的详细上下文信息
  - _需求: 需求8_

### 阶段四：管理接口实现

- [x] **9. 角色管理 API**
  - 创建 RoleController (`src/auth/controllers/role.controller.ts`)
  - 实现角色的 CRUD 接口
  - 添加角色统计和查询接口
  - 确保所有接口都有 ADMIN 权限保护
  - _需求: 需求9_

- [x] **10. 用户角色管理 API**
  - 扩展 UserController 或创建 AdminUserController
  - 实现用户角色分配和移除接口
  - 添加用户角色查询接口
  - 实现批量角色操作功能
  - _需求: 需求9_

- [x] **11. API 文档更新**
  - 更新所有新接口的 Swagger 文档
  - 添加角色权限的说明和示例
  - 更新认证相关的文档说明
  - 添加错误响应的文档示例
  - _需求: 需求9_

### 阶段五：数据初始化和迁移

- [ ] **12. 数据库迁移执行**
  - 执行角色表和关联表的创建迁移
  - 初始化系统默认角色 (USER, ADMIN)
  - 为现有用户分配默认 USER 角色
  - 验证数据迁移的完整性
  - _需求: 需求1, 需求2_

- [ ] **13. 系统配置更新**
  - 更新环境变量配置 (如有需要)
  - 更新 Docker 配置支持新的数据库结构
  - 更新部署脚本包含角色初始化
  - 添加角色系统的配置文档
  - _需求: 需求1_

### 阶段六：测试实现

- [ ] **14. 单元测试**
  - RoleService 的单元测试
  - RolesGuard 的单元测试
  - 装饰器功能的单元测试
  - JWT 载荷扩展的测试
  - _需求: 需求10_

- [ ] **15. 集成测试**
  - 权限守卫的集成测试
  - 角色分配和验证的集成测试
  - 异常处理的集成测试
  - API 接口的集成测试
  - _需求: 需求10_

- [ ] **16. E2E 测试**
  - 不同角色用户的完整访问流程测试
  - 权限边界和安全性测试
  - 角色管理的端到端测试
  - 性能和并发测试
  - _需求: 需求10_

### 阶段七：优化和部署

- [ ] **17. 性能优化**
  - 实现角色信息的缓存策略
  - 优化数据库查询性能
  - 添加必要的数据库索引
  - 监控和分析性能指标
  - _需求: 所有需求_

- [ ] **18. 安全加固**
  - 安全性审查和测试
  - 防护权限提升攻击
  - 验证审计日志的完整性
  - 进行渗透测试
  - _需求: 需求7, 需求8_

- [ ] **19. 文档完善**
  - 编写详细的使用文档
  - 添加权限系统的架构文档
  - 创建开发者指南和最佳实践
  - 更新项目 README 和部署指南
  - _需求: 所有需求_

- [ ] **20. 部署和监控**
  - 准备生产环境部署
  - 配置权限相关的监控和告警
  - 建立权限使用的统计和分析
  - 制定权限系统的维护计划
  - _需求: 需求8_

## 实施顺序和依赖关系

### 关键路径
1. **基础架构** (任务 1-3) → **权限控制** (任务 4-6) → **管理接口** (任务 9-11)
2. **异常处理** (任务 7-8) 可以与权限控制并行开发
3. **测试实现** (任务 14-16) 在每个阶段完成后立即进行
4. **优化部署** (任务 17-20) 在核心功能完成后进行

### 里程碑检查点
- **M1**: 完成基础架构搭建 (任务 1-3)
- **M2**: 完成权限控制核心功能 (任务 4-6)
- **M3**: 完成管理接口和异常处理 (任务 7-11)
- **M4**: 完成数据迁移和测试 (任务 12-16)
- **M5**: 完成优化和部署准备 (任务 17-20)

## 风险评估和应对措施

### 高风险项
- **数据迁移**: 现有用户的角色分配可能影响线上服务
  - *应对*: 详细的迁移脚本测试，支持回滚操作
- **守卫顺序**: 多个守卫的执行顺序可能导致意外行为
  - *应对*: 充分的集成测试，分阶段部署验证

### 中风险项
- **性能影响**: 角色验证增加的延迟
  - *应对*: JWT 缓存策略，性能基准测试
- **向后兼容**: 新权限系统对现有 API 的影响
  - *应对*: 渐进式部署，充分的回归测试

## 质量保证

### 代码质量
- 所有新代码必须通过 ESLint 检查
- 单元测试覆盖率不低于 90%
- 集成测试覆盖所有权限场景

### 安全质量
- 权限验证逻辑的安全审查
- 防止常见的权限攻击向量
- 审计日志的完整性验证

### 性能质量
- API 响应时间不超过现有基准的 10%
- 数据库查询优化和索引设计
- 缓存命中率监控和优化
