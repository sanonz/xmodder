# XModder 游戏修改器服务

## 项目概述
这是一个生产级的 NestJS 认证系统，采用**严格的 RESTful API 设计**，支持邮箱/手机号/用户名登录、JWT 令牌、验证码和全面的会话管理。架构强调类型安全、安全性和标准化响应。

## 工作流
你会根据用户的需求智能判断使用哪种模式来开发，默认情况下采用 spec 来开发

**智能判断标准：**
- **使用 spec**：新功能开发、复杂架构设计、多模块集成、涉及数据库/UI设计
- **跳过 spec**：简单修复、文档更新、配置修改、代码重构

### Workflow 命令控制
用户也可以通过指令来要求

**可用命令：**
- **/spec** - 强制使用完整 spec 流程
- **/no_spec** - 跳过 spec 流程，直接执行
- **/help** - 显示命令帮助

以下是 spec 工作流：
0. 请注意！必须遵守以下的规则，每个环节完成后都需要由我进行确认后才可进行下一个环节；
1. 如果你判断我的输入提出的是一个新需求，可以按照下面的标准软件工程的方式独立开展工作，需要时才向我询问，可以采用 interactiveDialog 工具来收集
2. 每当我输入新的需求的时候，为了规范需求质量和验收标准，必须首先会搞清楚问题和需求，然后再进入下一阶段
3. 需求文档和验收标准设计：首先完成需求的设计,按照 EARS 简易需求语法方法来描述,如果你判断需求涉及到前端页面，需要在需求中提前确定好设计风格和配色，必须跟我进行确认需求细节，最终确认清楚后，需求定稿，然后再进入下一阶段，保存在 `specs/spec_name/requirements.md` 中，参考格式如下
```markdown
# 需求文档

## 介绍
需求描述

## 需求

### 需求 1 - 需求名称
**用户故事：** 用户故事内容

#### 验收标准
1. 采用 ERAS 描述的子句 While <可选前置条件>, when <可选触发器>, the <系统名称> shall <系统响应>，例如 When 选择"静音"时，笔记本电脑应当抑制所有音频输出。
2. ...
...
```
4. 技术方案设计： 在完成需求的设计之后，你会根据当前的技术架构和前面确认好的需求，进行需求的技术方案设计，精简但是能够准确的描述技术的架构（例如架构、技术栈、技术选型、数据库/接口设计、测试策略、安全性），必要时可以用 mermaid 来绘图，必须跟我确认清楚后，保存在  `specs/spec_name/design.md`  中，然后再进入下一阶段
5. 任务拆分：在完成技术方案设计后，你会根据需求文档和技术方案，细化具体要做的事情，必须跟我确认清楚后，，保存在`specs/spec_name/tasks.md` 中, 然后再进入下一阶段，开始正式执行任务，同时需要及时更新任务的状态，执行的时候尽可能独立自主运行，保证效率和质量

任务参考格式如下

``` markdown
# 实施计划
- [ ] 1. 任务信息
  - 具体要做的事情
  - ...
  - _需求: 相关的需求点的编号
```

## 集成要点

### TypeORM 配置
- **实体**: 从 `entities/` 目录自动加载
- **同步**: 仅在开发模式下启用
- **迁移**: 生产环境使用显式迁移

### 缓存策略
- **Redis**: 会话存储和频率限制
- **内存**: 通过 `@nestjs/cache-manager` 的开发环境回退

### API 文档
- **Swagger**: 在 `/api/docs` 自动生成
- **示例**: 所有端点包含请求/响应示例
- **认证**: 文档化 Bearer 令牌支持

## 错误处理

### 异常过滤器模式
全局 `AllExceptionsFilter` 标准化所有错误响应：
1. HTTP 异常自动格式化
2. 数据库错误映射到适当的状态码  
3. 验证错误包含字段专用消息

## 测试约定

### 文件结构
```
test/                   # E2E 测试
src/**/*.spec.ts        # 单元测试
```

## 重要文件清单

### 设计规范文档
- `docs/RESTFUL_DESIGN.md` - 完整的 API 规范和设计原则
- `docs/USER.md` - 完整用户认证体系规范和设计原则

### 业务代码文件
- `src/auth/auth.controller.ts` - RESTful 端点定义和响应格式化
- `src/auth/auth.service.ts` - 核心认证逻辑和安全实现  
- `src/user/entities/user.entity.ts` - 具有数据库约束的用户模型
- `src/common/interceptors/response.interceptor.ts` - 响应标准化

### 开发环境配置文件
- `docker-compose.yml` - 本地开发环境设置

## 新功能快速入门

1. **新端点**: 始终遵循现有控制器的 RESTful 资源模式
2. **DTOs**: 使用 class-validator 装饰器创建，包含 Swagger 文档
3. **服务**: 通过构造函数注入依赖，正确使用 TypeORM 操作符
4. **审计日志**: 完整的操作日志记录，支持安全分析
5. **测试**: 为认证流程编写单元测试和 E2E 测试
6. **文档**: 更新 Swagger 装饰器，包含符合 IResponseBody 格式的示例
